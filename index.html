<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana On-Chain Memo Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #0f172a; min-height: 100vh; display: flex; justify-content: center; padding: 20px; color: #e2e8f0; }
        .container { width: 100%; max-width: 600px; }
        .card { background: #1e293b; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); margin-bottom: 20px; border: 1px solid #334155; }
        h1 { font-size: 20px; color: #f1f5f9; margin-bottom: 4px; }
        .sub { font-size: 13px; color: #94a3b8; margin-bottom: 20px; }
        
        .wallet-bar { display: flex; justify-content: space-between; align-items: center; background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .wallet-info { font-size: 13px; font-weight: 500; color: #f1f5f9; }
        .wallet-addr { font-family: monospace; color: #cbd5e1; font-size: 11px; margin-top: 2px; }
        .wallet-balance { font-size: 12px; color: #4ade80; font-weight: 600; margin-top: 4px; }
        
        button { background: #3b82f6; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        button:hover:not(:disabled) { background: #2563eb; }
        button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; }
        button.disconnect { background: #ef4444; }
        button.disconnect:hover { background: #dc2626; }
        
        .input-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: #cbd5e1; }
        textarea, input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 8px; font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #f1f5f9; }
        textarea { min-height: 100px; resize: vertical; }
        textarea:focus, input:focus { border-color: #3b82f6; }
        
        .meta { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 4px; }
        
        .fee-section { background: #1e3a8a33; border: 1px solid #1e40af; padding: 12px; border-radius: 8px; font-size: 13px; color: #93c5fd; margin-bottom: 16px; }
        .fee-label { font-weight: 500; margin-bottom: 8px; color: #bfdbfe; }
        .fee-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .fee-btn { padding: 6px 12px; font-size: 12px; border-radius: 4px; background: #0f172a; color: #60a5fa; border: 1px solid #3b82f6; cursor: pointer; }
        .fee-btn.active { background: #3b82f6; color: #fff; }
        .fee-btn:hover:not(.active) { background: #1e293b; }
        .fee-custom { display: none; margin-top: 10px; }
        .fee-custom.show { display: flex; gap: 8px; align-items: center; }
        .fee-custom input { width: 120px; padding: 6px 8px; font-size: 12px; border: 1px solid #3b82f6; border-radius: 4px; background: #0f172a; color: #fff; }
        .fee-display { margin-top: 10px; font-weight: 600; padding-top: 8px; border-top: 1px solid #1e40af; color: #60a5fa; }
        
        .config-section { background: #42200633; border: 1px solid #854d0e; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
        .config-section label { color: #fde047; font-size: 12px; margin-bottom: 4px; }
        .config-section input { font-family: monospace; font-size: 12px; padding: 8px; border-color: #854d0e; }
        .config-section .hint { font-size: 11px; color: #ca8a04; margin-top: 4px; }
        
        .feed { margin-top: 30px; }
        .feed-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .feed-title { font-size: 16px; font-weight: 600; color: #f1f5f9; }
        .feed-subtitle { font-size: 11px; color: #64748b; font-family: monospace; margin-top: 2px; }
        .feed-refresh { font-size: 12px; color: #3b82f6; cursor: pointer; text-decoration: underline; background: none; padding: 0; }
        .feed-refresh:hover { color: #60a5fa; }
        
        .msg-item { background: #1e293b; padding: 16px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 12px; }
        .msg-item:hover { border-color: #475569; }
        .msg-content { font-size: 14px; line-height: 1.5; color: #e2e8f0; white-space: pre-wrap; word-break: break-word; }
        .msg-footer { margin-top: 10px; display: flex; justify-content: space-between; font-size: 11px; color: #64748b; align-items: center; }
        .msg-sig { font-family: monospace; color: #3b82f6; text-decoration: none; }
        .msg-sig:hover { text-decoration: underline; color: #60a5fa; }

        .status { padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; display: none; text-align: center; font-weight: 500; }
        .status.success { background: #052e16; color: #4ade80; border: 1px solid #166534; display: block; }
        .status.error { background: #450a0a; color: #f87171; border: 1px solid #991b1b; display: block; }
        .status.info { background: #082f49; color: #38bdf8; border: 1px solid #075985; display: block; }
        .status a { color: inherit; text-decoration: underline; }
        
        .full-width { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Solana On-Chain Memo Tool</h1>
            <p class="sub">Inscribe permanent data on Solana. Optional fees for spam resistance.</p>
            
            <div id="status" class="status"></div>

            <div class="wallet-bar">
                <div>
                    <div id="w-stat" class="wallet-info">Wallet not connected</div>
                    <div id="w-addr" class="wallet-addr"></div>
                    <div id="w-balance" class="wallet-balance"></div>
                </div>
                <button id="w-btn">Connect Wallet</button>
            </div>

            <div class="config-section">
                <label>Fee Recipient </label>
                <input type="text" id="pot-input" placeholder="Enter Solana wallet address..." />
                <div class="hint">Fees go to this address. Saved in your browser.</div>
            </div>

            <div class="fee-section">
                <div class="fee-label">Inscription Fee</div>
                <div class="fee-options">
                    <button type="button" class="fee-btn" data-fee="0">No Fee (Gas Only)</button>
                    <button type="button" class="fee-btn active" data-fee="10000">0.00001 SOL</button>
                    <button type="button" class="fee-btn" data-fee="100000">0.0001 SOL</button>
                    <button type="button" class="fee-btn" data-fee="custom">Custom</button>
                </div>
                <div id="fee-custom" class="fee-custom">
                    <input type="number" id="custom-fee-input" placeholder="0.0001" step="0.00001" min="0" />
                    <span>SOL</span>
                </div>
                <div id="fee-display" class="fee-display">Selected: 0.00001 SOL</div>
            </div>

            <div class="input-group">
                <label>Your Message</label>
                <textarea id="msg" placeholder="Write something meaningful..." maxlength="500"></textarea>
                <div class="meta">
                    <span id="chars">0/500</span>
                    <span id="bytes">0 bytes</span>
                </div>
            </div>

            <button id="send-btn" class="full-width" disabled>Inscribe</button>
        </div>

        <div class="feed">
            <div class="feed-header">
                <div>
                    <div class="feed-title">Recent Inscriptions</div>
                    <div id="feed-wallet" class="feed-subtitle"></div>
                </div>
                <button id="refresh-btn" class="feed-refresh">Refresh Feed</button>
            </div>
            <div id="feed-list">
                <div style="text-align: center; color: #94a3b8; font-size: 13px; padding: 20px;">Loading feed...</div>
            </div>
        </div>
        
    </div>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        // CONFIG
        const DEFAULT_POT = 'EQ3W43KtTw6mMW8ojYQSEPCdYUw8GUqRdBRui8mi4H7A';
        const MEMO_PROGRAM = 'Memo1UhkJRfHyvLMcVucJwxXeuD728EqVDDwQDxFMNo';
        const MAX_BYTES = 560;
        
        // RPCs with fallback
        const RPCS = [
            'https://solana.drpc.org',
            'https://solana.lavenderfive.com',
            'https://public.rpc.solanavibestation.com',
            'https://api.mainnet-beta.solana.com'
        ];

        // STATE
        let wallet = null;
        let pubkey = null;
        let solPrice = 0;
        let balanceInterval = null;
        let selectedFeeLamports = 10000; // Default 0.00001 SOL
        const $ = id => document.getElementById(id);
        
        // Get pot wallet (from localStorage or default)
        const getPotWallet = () => {
            const saved = localStorage.getItem('potWallet');
            return saved && saved.length >= 32 ? saved : DEFAULT_POT;
        };

        // UTILS
        const showStatus = (type, msg) => {
            const el = $('status');
            el.className = `status ${type}`;
            el.innerHTML = msg;
            el.style.display = 'block';
        };
        
        const hideStatus = () => {
            $('status').style.display = 'none';
        };

        const shortAddr = (str) => str ? str.slice(0, 4) + '...' + str.slice(-4) : '';
        
        // RPC helper
        async function rpc(method, params) {
            for (const ep of RPCS) {
                try {
                    const r = await fetch(ep, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({jsonrpc: '2.0', id: 1, method, params})
                    });
                    if (r.ok) {
                        const d = await r.json();
                        if (d.result) return { result: d.result, rpcUrl: ep };
                    }
                } catch (e) { continue; }
            }
            throw new Error('RPC connection failed');
        }
        
        // SOL Price (CoinGecko)
        async function fetchSolPrice() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
                const data = await res.json();
                solPrice = parseFloat(data?.solana?.usd || 0);
                updateFeeDisplay();
            } catch (e) { console.warn('Price fetch failed:', e); }
        }
        
        function updateFeeDisplay() {
            const feeSol = selectedFeeLamports / 1e9;
            const feeUsd = solPrice > 0 ? (feeSol * solPrice).toFixed(4) : null;
            
            if (selectedFeeLamports === 0) {
                $('fee-display').textContent = 'Selected: None (Gas Only)';
                $('send-btn').textContent = 'Inscribe (Gas Only)';
            } else {
                $('fee-display').textContent = `Selected: ${feeSol} SOL` + (feeUsd ? ` (~$${feeUsd})` : '');
                $('send-btn').textContent = `Inscribe (${feeSol} SOL + Gas)`;
            }
        }
        
        // Fee button handling
        document.querySelectorAll('.fee-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.fee-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const feeVal = btn.dataset.fee;
                if (feeVal === 'custom') {
                    $('fee-custom').classList.add('show');
                    const customVal = parseFloat($('custom-fee-input').value) || 0;
                    selectedFeeLamports = Math.floor(customVal * 1e9);
                } else {
                    $('fee-custom').classList.remove('show');
                    selectedFeeLamports = parseInt(feeVal);
                }
                updateFeeDisplay();
            };
        });
        
        $('custom-fee-input').oninput = () => {
            const customVal = parseFloat($('custom-fee-input').value) || 0;
            selectedFeeLamports = Math.floor(customVal * 1e9);
            updateFeeDisplay();
        };
        
        // Wallet balance
        async function updateBalance() {
            if (!pubkey) return;
            try {
                const { result } = await rpc('getBalance', [pubkey.toString()]);
                const sol = (result?.value || 0) / 1e9;
                const usd = solPrice > 0 ? (sol * solPrice).toFixed(2) : null;
                $('w-balance').textContent = `${sol.toFixed(4)} SOL` + (usd ? ` (~$${usd})` : '');
            } catch (e) { console.warn('Balance fetch failed:', e); }
        }
        
        async function startBalanceUpdates() {
            await fetchSolPrice();
            await updateBalance();
            if (balanceInterval) clearInterval(balanceInterval);
            balanceInterval = setInterval(async () => {
                await fetchSolPrice();
                await updateBalance();
            }, 30000);
        }
        
        function stopBalanceUpdates() {
            if (balanceInterval) {
                clearInterval(balanceInterval);
                balanceInterval = null;
            }
            $('w-balance').textContent = '';
        }

        // Pot wallet input
        $('pot-input').value = getPotWallet();
        $('pot-input').onchange = () => {
            const val = $('pot-input').value.trim();
            if (val.length >= 32 && val.length <= 44) {
                localStorage.setItem('potWallet', val);
                showStatus('success', 'wallet saved!');
                setTimeout(hideStatus, 2000);
                loadFeed();
            } else if (val) {
                showStatus('error', 'Invalid wallet address');
            }
        };

        // WALLET CONNECTION
        $('w-btn').onclick = async () => {
            if (wallet) {
                wallet.disconnect();
                wallet = null;
                pubkey = null;
                $('w-stat').textContent = 'Wallet not connected';
                $('w-addr').textContent = '';
                $('w-btn').textContent = 'Connect Wallet';
                $('w-btn').classList.remove('disconnect');
                $('send-btn').disabled = true;
                stopBalanceUpdates();
                return;
            }

            if (!window.solana) return showStatus('error', 'Phantom wallet not found');
            
            try {
                const resp = await window.solana.connect();
                wallet = window.solana;
                pubkey = resp.publicKey;
                $('w-stat').textContent = 'Connected';
                $('w-addr').textContent = pubkey.toString();
                $('w-btn').textContent = 'Disconnect';
                $('w-btn').classList.add('disconnect');
                hideStatus();
                updateInput();
                startBalanceUpdates();
            } catch (err) {
                showStatus('error', err.message);
            }
        };

        // INPUT HANDLING
        const updateInput = () => {
            const text = $('msg').value;
            const bytes = new TextEncoder().encode(text).length;
            const potValid = $('pot-input').value.trim().length >= 32;
            $('chars').textContent = `${text.length}/500`;
            $('bytes').textContent = `${bytes} bytes`;
            
            // For gas-only mode, pot wallet doesn't need to be valid
            const needsPot = selectedFeeLamports > 0;
            const isValid = text.trim().length > 0 && bytes <= MAX_BYTES && wallet && (!needsPot || potValid);
            $('send-btn').disabled = !isValid;
            $('bytes').style.color = bytes > MAX_BYTES ? '#ef4444' : '#94a3b8';
        };
        $('msg').oninput = updateInput;

        // INSCRIBE
        $('send-btn').onclick = async () => {
            const text = $('msg').value.trim();
            const potWallet = getPotWallet();
            if (!text || !wallet) return;
            if (selectedFeeLamports > 0 && !potWallet) return;

            $('send-btn').disabled = true;
            $('send-btn').textContent = 'Processing...';
            showStatus('info', 'Fetching blockhash...');

            try {
                const { result: bh } = await rpc('getLatestBlockhash', [{commitment: 'confirmed'}]);
                if (!bh?.value?.blockhash) throw new Error('Failed to get blockhash');

                showStatus('info', 'Please approve in wallet...');

                const tx = new solanaWeb3.Transaction({
                    recentBlockhash: bh.value.blockhash,
                    feePayer: pubkey
                });

                tx.add(solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ microLamports: 50000 }));

                // Only add fee transfer if fee > 0
                if (selectedFeeLamports > 0) {
                    tx.add(solanaWeb3.SystemProgram.transfer({
                        fromPubkey: pubkey,
                        toPubkey: new solanaWeb3.PublicKey(potWallet),
                        lamports: selectedFeeLamports
                    }));
                }

                tx.add(new solanaWeb3.TransactionInstruction({
                    keys: [{ pubkey: pubkey, isSigner: true, isWritable: false }],
                    programId: new solanaWeb3.PublicKey(MEMO_PROGRAM),
                    data: new TextEncoder().encode(text)
                }));

                const sigResp = await wallet.signAndSendTransaction(tx);
                const signature = typeof sigResp === 'string' ? sigResp : sigResp?.signature || sigResp;
                
                showStatus('info', 'Confirming on-chain...');
                
                let confirmed = false;
                let failed = false;
                
                for (let i = 0; i < 15; i++) {
                    await new Promise(r => setTimeout(r, 2000));
                    
                    try {
                        const { result: statusResult } = await rpc('getSignatureStatuses', [[signature], { searchTransactionHistory: true }]);
                        const status = statusResult?.value?.[0];
                        
                        if (status?.err) { failed = true; break; }
                        if (status?.confirmationStatus === 'confirmed' || status?.confirmationStatus === 'finalized') {
                            confirmed = true;
                            break;
                        }
                    } catch (e) {}
                }
                
                if (confirmed) {
                    showStatus('success', `SUCCESS! Message inscribed. <a href="https://solscan.io/tx/${signature}" target="_blank">View on Solscan</a>`);
                    $('msg').value = '';
                    updateInput();
                    updateBalance();
                    setTimeout(loadFeed, 3000);
                } else if (failed) {
                    showStatus('error', `Transaction failed on-chain. <a href="https://solscan.io/tx/${signature}" target="_blank">View details</a>`);
                } else {
                    showStatus('info', `Transaction sent but not yet confirmed. <a href="https://solscan.io/tx/${signature}" target="_blank">Check Solscan</a>`);
                }

            } catch (err) {
                console.error(err);
                showStatus('error', 'Failed: ' + err.message);
            }
            
            $('send-btn').disabled = false;
            updateFeeDisplay();
        };

        // FEED LOADING
        async function loadFeed() {
            const list = $('feed-list');
            const potWallet = getPotWallet();
            
            // Show abbreviated pot wallet in feed header
            $('feed-wallet').textContent = potWallet ? `Scanning: ${shortAddr(potWallet)}` : '';
            
            if (!potWallet || potWallet.length < 32) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">Set a valid pot wallet to view feed.</div>';
                return;
            }
            
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #3b82f6;">Loading feed...</div>';

            try {
                const { result: signatures } = await rpc('getSignaturesForAddress', [potWallet, { limit: 20 }]);

                if (!signatures || signatures.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px;">No messages yet. Be the first!</div>';
                    return;
                }

                const validMemos = [];
                
                for (const sigInfo of signatures) {
                    if (sigInfo.err) continue;

                    try {
                        const { result: tx } = await rpc('getTransaction', [
                            sigInfo.signature,
                            { encoding: 'jsonParsed', maxSupportedTransactionVersion: 0 }
                        ]);

                        if (!tx) continue;

                        const memoIx = tx.transaction.message.instructions.find(ix => 
                            ix.programId === MEMO_PROGRAM || ix.program === 'spl-memo'
                        );

                        if (memoIx) {
                            let content = null;
                            if (memoIx.parsed) content = memoIx.parsed;
                            else if (memoIx.data) {
                                try {
                                    content = new TextDecoder().decode(
                                        Uint8Array.from(atob(memoIx.data), c => c.charCodeAt(0))
                                    );
                                } catch (e) { continue; }
                            }

                            if (content && content.length > 2 && content.length <= 500) {
                                validMemos.push({
                                    signature: sigInfo.signature,
                                    text: content,
                                    time: sigInfo.blockTime * 1000,
                                    sender: tx.transaction.message.accountKeys[0]?.pubkey
                                });
                            }
                        }
                    } catch (e) { continue; }
                }

                if (validMemos.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px;">No valid memos found recently.</div>';
                    return;
                }

                list.innerHTML = validMemos.map(m => `
                    <div class="msg-item">
                        <div class="msg-content">${escapeHtml(m.text)}</div>
                        <div class="msg-footer">
                            <span>${new Date(m.time).toLocaleString()}</span>
                            <a href="https://solscan.io/tx/${m.signature}" target="_blank" class="msg-sig">
                                ${shortAddr(m.signature)}
                            </a>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error(err);
                list.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">Failed to load feed.</div>';
            }
        }

        const escapeHtml = (unsafe) => {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        };

        $('refresh-btn').onclick = loadFeed;

        // Auto-connect if wallet already connected
        if (window.solana?.publicKey) {
            wallet = window.solana;
            pubkey = window.solana.publicKey;
            $('w-stat').textContent = 'Connected';
            $('w-addr').textContent = pubkey.toString();
            $('w-btn').textContent = 'Disconnect';
            $('w-btn').classList.add('disconnect');
            updateInput();
            startBalanceUpdates();
        }
        
        // Fetch price on load (for fee display)
        fetchSolPrice();
        
        // Initial fee display update
        updateFeeDisplay();
        
        // Initial load
        loadFeed();
    </script>
</body>
</html>
