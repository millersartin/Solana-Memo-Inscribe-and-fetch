<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana On-Chain Memo Tool</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --border: #334155; --txt: #e2e8f0; --muted: #94a3b8; --accent: #3b82f6; --green: #4ade80; --red: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; padding: 20px; color: var(--txt); }
        .container { width: 100%; max-width: 600px; }
        .card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px #0008; margin-bottom: 20px; border: 1px solid var(--border); }
        h1 { font-size: 20px; color: #f1f5f9; margin-bottom: 4px; }
        .sub { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
        .wallet-bar { display: flex; justify-content: space-between; align-items: center; background: var(--border); padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .wallet-info { font-size: 13px; font-weight: 500; }
        .wallet-addr { font-family: monospace; color: #cbd5e1; font-size: 11px; margin-top: 2px; }
        .wallet-balance { font-size: 12px; color: var(--green); font-weight: 600; margin-top: 4px; }
        button { background: var(--accent); color: #fff; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        button:hover:not(:disabled) { filter: brightness(1.1); }
        button:disabled { background: #475569; color: var(--muted); cursor: not-allowed; }
        button.disconnect { background: var(--red); }
        label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: #cbd5e1; }
        textarea, input { width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 8px; font-family: inherit; font-size: 14px; outline: none; background: var(--bg); color: #f1f5f9; }
        textarea { min-height: 100px; resize: vertical; }
        textarea:focus, input:focus { border-color: var(--accent); }
        .meta { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 4px; }
        .fee-section { background: #1e3a8a33; border: 1px solid #1e40af; padding: 12px; border-radius: 8px; font-size: 13px; color: #93c5fd; margin-bottom: 16px; }
        .fee-label { font-weight: 500; margin-bottom: 8px; color: #bfdbfe; }
        .fee-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .fee-btn { padding: 6px 12px; font-size: 12px; border-radius: 4px; background: var(--bg); color: #60a5fa; border: 1px solid var(--accent); cursor: pointer; }
        .fee-btn.active { background: var(--accent); color: #fff; }
        .fee-btn:hover:not(.active) { background: var(--card); }
        .fee-custom { display: none; margin-top: 10px; }
        .fee-custom.show { display: flex; gap: 8px; align-items: center; }
        .fee-custom input { width: 120px; padding: 6px 8px; font-size: 12px; border-color: var(--accent); }
        .fee-display { margin-top: 10px; font-weight: 600; padding-top: 8px; border-top: 1px solid #1e40af; color: #60a5fa; }
        .config-section { background: #42200633; border: 1px solid #854d0e; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
        .config-section label { color: #fde047; font-size: 12px; }
        .config-section input { font-family: monospace; font-size: 12px; padding: 8px; border-color: #854d0e; }
        .config-section .hint { font-size: 11px; color: #ca8a04; margin-top: 4px; }
        .feed { margin-top: 30px; }
        .feed-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .feed-title { font-size: 16px; font-weight: 600; }
        .feed-subtitle { font-size: 11px; color: #64748b; font-family: monospace; margin-top: 2px; }
        .feed-refresh { font-size: 12px; color: var(--accent); cursor: pointer; text-decoration: underline; background: none; padding: 0; }
        .msg-item { background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px; }
        .msg-item:hover { border-color: #475569; }
        .msg-content { font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
        .msg-footer { margin-top: 10px; display: flex; justify-content: space-between; font-size: 11px; color: #64748b; }
        .msg-sig { font-family: monospace; color: var(--accent); text-decoration: none; }
        .msg-sig:hover { text-decoration: underline; }
        .status { padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; display: none; text-align: center; font-weight: 500; }
        .status.success { background: #052e16; color: var(--green); border: 1px solid #166534; display: block; }
        .status.error { background: #450a0a; color: #f87171; border: 1px solid #991b1b; display: block; }
        .status.info { background: #082f49; color: #38bdf8; border: 1px solid #075985; display: block; }
        .status a { color: inherit; text-decoration: underline; }
        .full-width { width: 100%; }
        .mb { margin-bottom: 16px; }
        .center { text-align: center; padding: 20px; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h1>Solana On-Chain Memo Tool</h1>
        <p class="sub">Inscribe permanent data on Solana. Optional fees for spam resistance.</p>
        <div id="status" class="status"></div>
        <div class="wallet-bar">
            <div>
                <div id="w-stat" class="wallet-info">Wallet not connected</div>
                <div id="w-addr" class="wallet-addr"></div>
                <div id="w-balance" class="wallet-balance"></div>
            </div>
            <button id="w-btn">Connect Wallet</button>
        </div>
        <div class="config-section">
            <label>Fee Recipient</label>
            <input type="text" id="pot-input" placeholder="Enter Solana wallet address..." />
            <div class="hint">Fees go to this address. Saved in your browser.</div>
        </div>
        <div class="fee-section">
            <div class="fee-label">Inscription Fee</div>
            <div class="fee-options">
                <button type="button" class="fee-btn" data-fee="0">No Fee (Gas Only)</button>
                <button type="button" class="fee-btn active" data-fee="10000">0.00001 SOL</button>
                <button type="button" class="fee-btn" data-fee="100000">0.0001 SOL</button>
                <button type="button" class="fee-btn" data-fee="custom">Custom</button>
            </div>
            <div id="fee-custom" class="fee-custom">
                <input type="number" id="custom-fee" placeholder="0.0001" step="0.00001" min="0" />
                <span>SOL</span>
            </div>
            <div id="fee-display" class="fee-display">Selected: 0.00001 SOL</div>
        </div>
        <div class="mb">
            <label>Your Message</label>
            <textarea id="msg" placeholder="Write something meaningful..." maxlength="500"></textarea>
            <div class="meta"><span id="chars">0/500</span><span id="bytes">0 bytes</span></div>
        </div>
        <button id="send-btn" class="full-width" disabled>Inscribe</button>
    </div>
    <div class="feed">
        <div class="feed-header">
            <div><div class="feed-title">Recent Inscriptions</div><div id="feed-wallet" class="feed-subtitle"></div></div>
            <button id="refresh-btn" class="feed-refresh">Refresh</button>
        </div>
        <div id="feed-list"><div class="center" style="color:#94a3b8">Loading...</div></div>
    </div>
</div>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<script>
const CFG = {
    POT: 'EQ3W43KtTw6mMW8ojYQSEPCdYUw8GUqRdBRui8mi4H7A',
    MEMO: 'Memo1UhkJRfHyvLMcVucJwxXeuD728EqVDDwQDxFMNo',
    MAX: 560,
    RPCS: ['https://solana.drpc.org','https://solana.lavenderfive.com','https://public.rpc.solanavibestation.com','https://api.mainnet-beta.solana.com']
};

let wallet, pubkey, solPrice = 0, balInt, feeLam = 10000;
const $ = id => document.getElementById(id), esc = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
const short = s => s ? s.slice(0,4)+'...'+s.slice(-4) : '';
const getPot = () => { const s = localStorage.getItem('potWallet'); return s?.length >= 32 ? s : CFG.POT; };
const show = (t,m) => { const e = $('status'); e.className = `status ${t}`; e.innerHTML = m; e.style.display = 'block'; };
const hide = () => $('status').style.display = 'none';

async function rpc(method, params) {
    for (const ep of CFG.RPCS) {
        try {
            const r = await fetch(ep, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({jsonrpc:'2.0',id:1,method,params}) });
            if (r.ok) { const d = await r.json(); if (d.result) return d.result; }
        } catch {}
    }
    throw new Error('RPC failed');
}

async function getPrice() {
    try { solPrice = (await (await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd')).json())?.solana?.usd || 0; } catch {}
    updateFee();
}

function updateFee() {
    const sol = feeLam / 1e9, usd = solPrice > 0 ? ` (~$${(sol * solPrice).toFixed(4)})` : '';
    $('fee-display').textContent = feeLam ? `Selected: ${sol} SOL${usd}` : 'Selected: None (Gas Only)';
    $('send-btn').textContent = feeLam ? `Inscribe (${sol} SOL + Gas)` : 'Inscribe (Gas Only)';
}

async function updateBal() {
    if (!pubkey) return;
    try {
        const sol = ((await rpc('getBalance', [pubkey.toString()]))?.value || 0) / 1e9;
        $('w-balance').textContent = `${sol.toFixed(4)} SOL${solPrice ? ` (~$${(sol*solPrice).toFixed(2)})` : ''}`;
    } catch {}
}

function startBal() { getPrice(); updateBal(); if (balInt) clearInterval(balInt); balInt = setInterval(() => { getPrice(); updateBal(); }, 30000); }
function stopBal() { if (balInt) clearInterval(balInt); balInt = null; $('w-balance').textContent = ''; }

// Init pot input
$('pot-input').value = getPot();
$('pot-input').onchange = () => {
    const v = $('pot-input').value.trim();
    if (v.length >= 32 && v.length <= 44) { localStorage.setItem('potWallet', v); show('success','Wallet saved!'); setTimeout(hide,2000); loadFeed(); }
    else if (v) show('error','Invalid wallet address');
};

// Fee buttons
document.querySelectorAll('.fee-btn').forEach(btn => btn.onclick = () => {
    document.querySelectorAll('.fee-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const v = btn.dataset.fee;
    $('fee-custom').classList.toggle('show', v === 'custom');
    feeLam = v === 'custom' ? Math.floor((parseFloat($('custom-fee').value) || 0) * 1e9) : parseInt(v);
    updateFee();
});
$('custom-fee').oninput = () => { feeLam = Math.floor((parseFloat($('custom-fee').value) || 0) * 1e9); updateFee(); };

// Wallet
$('w-btn').onclick = async () => {
    if (wallet) { wallet.disconnect(); wallet = pubkey = null; $('w-stat').textContent = 'Wallet not connected'; $('w-addr').textContent = ''; $('w-btn').textContent = 'Connect Wallet'; $('w-btn').classList.remove('disconnect'); $('send-btn').disabled = true; stopBal(); return; }
    if (!window.solana) return show('error','Phantom wallet not found');
    try {
        const r = await window.solana.connect(); wallet = window.solana; pubkey = r.publicKey;
        $('w-stat').textContent = 'Connected'; $('w-addr').textContent = pubkey.toString(); $('w-btn').textContent = 'Disconnect'; $('w-btn').classList.add('disconnect');
        hide(); updateInput(); startBal();
    } catch (e) { show('error', e.message); }
};

// Input validation
const updateInput = () => {
    const txt = $('msg').value, len = new TextEncoder().encode(txt).length;
    $('chars').textContent = `${txt.length}/500`; $('bytes').textContent = `${len} bytes`;
    $('bytes').style.color = len > CFG.MAX ? '#ef4444' : '#94a3b8';
    $('send-btn').disabled = !(txt.trim() && len <= CFG.MAX && wallet && (feeLam === 0 || getPot()?.length >= 32));
};
$('msg').oninput = updateInput;

// Inscribe
$('send-btn').onclick = async () => {
    const txt = $('msg').value.trim(), pot = getPot();
    if (!txt || !wallet || (feeLam > 0 && !pot)) return;
    $('send-btn').disabled = true; $('send-btn').textContent = 'Processing...'; show('info','Fetching blockhash...');
    try {
        const bh = await rpc('getLatestBlockhash', [{commitment:'confirmed'}]);
        if (!bh?.value?.blockhash) throw new Error('Failed to get blockhash');
        show('info','Please approve in wallet...');
        const tx = new solanaWeb3.Transaction({ recentBlockhash: bh.value.blockhash, feePayer: pubkey });
        tx.add(solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ microLamports: 50000 }));
        if (feeLam > 0) tx.add(solanaWeb3.SystemProgram.transfer({ fromPubkey: pubkey, toPubkey: new solanaWeb3.PublicKey(pot), lamports: feeLam }));
        tx.add(new solanaWeb3.TransactionInstruction({ keys: [{pubkey,isSigner:true,isWritable:false}], programId: new solanaWeb3.PublicKey(CFG.MEMO), data: new TextEncoder().encode(txt) }));
        const sig = (await wallet.signAndSendTransaction(tx))?.signature || (await wallet.signAndSendTransaction(tx));
        show('info','Confirming on-chain...');
        let ok = false, fail = false;
        for (let i = 0; i < 15 && !ok && !fail; i++) {
            await new Promise(r => setTimeout(r, 2000));
            try { const s = (await rpc('getSignatureStatuses', [[sig], {searchTransactionHistory:true}]))?.value?.[0]; if (s?.err) fail = true; else if (s?.confirmationStatus === 'confirmed' || s?.confirmationStatus === 'finalized') ok = true; } catch {}
        }
        if (ok) { show('success',`SUCCESS! <a href="https://solscan.io/tx/${sig}" target="_blank">View on Solscan</a>`); $('msg').value = ''; updateInput(); updateBal(); setTimeout(loadFeed,3000); }
        else if (fail) show('error',`Failed. <a href="https://solscan.io/tx/${sig}" target="_blank">View details</a>`);
        else show('info',`Sent. <a href="https://solscan.io/tx/${sig}" target="_blank">Check Solscan</a>`);
    } catch (e) { console.error(e); show('error','Failed: '+e.message); }
    $('send-btn').disabled = false; updateFee();
};

// Feed
async function loadFeed() {
    const list = $('feed-list'), pot = getPot();
    $('feed-wallet').textContent = pot ? `Scanning: ${short(pot)}` : '';
    if (!pot || pot.length < 32) { list.innerHTML = '<div class="center" style="color:#94a3b8">Set a valid wallet to view feed.</div>'; return; }
    list.innerHTML = '<div class="center" style="color:#3b82f6">Loading...</div>';
    try {
        const sigs = await rpc('getSignaturesForAddress', [pot, {limit:20}]);
        if (!sigs?.length) { list.innerHTML = '<div class="center">No messages yet. Be the first!</div>'; return; }
        const memos = [];
        for (const s of sigs) {
            if (s.err) continue;
            try {
                const tx = await rpc('getTransaction', [s.signature, {encoding:'jsonParsed',maxSupportedTransactionVersion:0}]);
                const ix = tx?.transaction?.message?.instructions?.find(i => i.programId === CFG.MEMO || i.program === 'spl-memo');
                if (!ix) continue;
                let c = ix.parsed || (ix.data ? new TextDecoder().decode(Uint8Array.from(atob(ix.data), x => x.charCodeAt(0))) : null);
                if (c?.length > 2 && c.length <= 500) memos.push({sig:s.signature, txt:c, time:s.blockTime*1000});
            } catch {}
        }
        list.innerHTML = memos.length ? memos.map(m => `<div class="msg-item"><div class="msg-content">${esc(m.txt)}</div><div class="msg-footer"><span>${new Date(m.time).toLocaleString()}</span><a href="https://solscan.io/tx/${m.sig}" target="_blank" class="msg-sig">${short(m.sig)}</a></div></div>`).join('') : '<div class="center">No valid memos found.</div>';
    } catch (e) { console.error(e); list.innerHTML = '<div class="center" style="color:#ef4444">Failed to load feed.</div>'; }
}
$('refresh-btn').onclick = loadFeed;

// Auto-connect
if (window.solana?.publicKey) { wallet = window.solana; pubkey = window.solana.publicKey; $('w-stat').textContent = 'Connected'; $('w-addr').textContent = pubkey.toString(); $('w-btn').textContent = 'Disconnect'; $('w-btn').classList.add('disconnect'); updateInput(); startBal(); }
getPrice(); updateFee(); loadFeed();
</script>
</body>
</html>
