<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Memo Inscriber</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: #fff; border-radius: 16px; padding: 32px; max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #333; margin-bottom: 8px; font-size: 24px; }
        .sub { color: #666; margin-bottom: 20px; font-size: 13px; }
        .wallet { margin-bottom: 20px; padding: 14px; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .wallet-addr { font-family: monospace; font-size: 11px; color: #666; word-break: break-all; width: 100%; display: none; }
        button { background: #667eea; color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        button:hover:not(:disabled) { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .panels { display: flex; gap: 16px; flex-wrap: wrap; }
        .panel { flex: 1 1 260px; background: #f9f9f9; border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px; }
        label { display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px; }
        textarea, input[type="text"] { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; }
        textarea:focus, input:focus { outline: none; border-color: #667eea; }
        .chars { text-align: right; font-size: 11px; color: #999; margin-top: 4px; }
        .chars.warn { color: #f59e0b; }
        .chars.err { color: #dc3545; }
        .opt { display: flex; align-items: center; gap: 6px; margin: 10px 0; font-size: 12px; color: #555; }
        .opt input { width: 14px; height: 14px; }
        .status { margin: 15px 0; padding: 15px; border-radius: 10px; font-size: 14px; font-weight: bold; text-align: center; display: none; line-height: 1.5; }
        .status.ok { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; display: block; }
        .status.err { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; display: block; }
        .status.info { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; display: block; }
        .status a { color: inherit; text-decoration: underline; }
        .copy { background: rgba(0,0,0,0.1); color: inherit; padding: 4px 8px; font-size: 11px; margin-left: 8px; border-radius: 4px; border:none; cursor: pointer; }
        .copy:hover { background: rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Solana Memo Inscriber</h1>
        <p class="sub">Write messages to Solana blockchain (~0.000005 SOL)</p>

        <div id="stat" class="status"></div>

        <div class="wallet">
            <div><strong>Wallet:</strong> <span id="wstat">Not Connected</span></div>
            <button id="wbtn">Connect</button>
            <div id="waddr" class="wallet-addr"></div>
        </div>

        <div class="panels">
            <div class="panel">
                <label>Your Message:</label>
                <textarea id="msg" placeholder="Type message..." maxlength="500"></textarea>
                <div id="chars" class="chars">0/500 (0 bytes)</div>
                <label class="opt"><input type="checkbox" id="prio" checked> Priority fee (50k ¬µLamports)</label>
                <button id="send" disabled style="width:100%;margin-top:8px;">Inscribe</button>
            </div>
            <div class="panel">
                <label>Lookup Memo by TX:</label>
                <input type="text" id="txin" placeholder="Paste signature...">
                <button id="lookup" style="width:100%;margin-top:10px;">Fetch Memo</button>
                <div id="lstat" class="status"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
    const MEMO = 'Memo1UhkJRfHyvLMcVucJwxXeuD728EqVDDwQDxFMNo', MAX = 560;
    const RPCS = ['https://solana.drpc.org','https://solana.lavenderfive.com','https://public.rpc.solanavibestation.com','https://solana.leorpc.com/?api_key=FREE','https://solana.api.onfinality.io/public','https://api.mainnet-beta.solana.com'];
    const PROXIES = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
    
    let wallet, pubkey, connected = false;
    const $ = id => document.getElementById(id);
    const show = (el, type, msg) => {
        // #region agent log
        fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:76',message:'show() called',data:{el:el?.id||'null',type,msg:msg?.substring(0,50),elExists:!!el,elDisplay:el?.style?.display||'not-set',elClassName:el?.className||'none'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H1,H2,H3'})}).catch(()=>{});
        // #endregion
        if (!el) {
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:78',message:'show() el is null',data:{type,msg},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H2'})}).catch(()=>{});
            // #endregion
            return;
        }
        el.className = `status ${type}`;
        el.innerHTML = msg;
        // #region agent log
        fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:83',message:'show() after update',data:{elId:el.id,className:el.className,innerHTML:el.innerHTML?.substring(0,50),computedDisplay:window.getComputedStyle(el).display,inlineDisplay:el.style.display||'not-set',offsetHeight:el.offsetHeight,offsetWidth:el.offsetWidth},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H1,H4,H5'})}).catch(()=>{});
        // #endregion
        // Force remove inline display:none if present
        if (el.style.display === 'none') {
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:87',message:'Removing inline display:none',data:{elId:el.id},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H1'})}).catch(()=>{});
            // #endregion
            el.style.display = '';
        }
    };

    // RPC helper: tries direct, then CORS proxies
    async function rpc(body) {
        for (const ep of RPCS) {
            // Direct
            try {
                const r = await fetch(ep, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (r.ok) { const d = await r.json(); if (d.result) return { data: d, url: ep }; }
            } catch {}
            // Proxies
            for (const p of PROXIES) {
                try {
                    const r = await fetch(p + encodeURIComponent(ep), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (r.ok) { const d = await r.json(); if (d.result) return { data: d, url: p + encodeURIComponent(ep) }; }
                } catch {}
            }
        }
        return null;
    }

    // Base58 decoder for memo fallback
    function b58(s) {
        const A = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz', b = [0];
        for (const c of s) { let carry = A.indexOf(c); if (carry < 0) throw 'bad'; for (let j = 0; j < b.length; j++) { const v = b[j] * 58 + carry; b[j] = v & 255; carry = v >> 8; } while (carry) { b.push(carry & 255); carry >>= 8; } }
        return new Uint8Array(b.reverse());
    }

    // Copy button handler
    document.addEventListener('click', e => {
        const btn = e.target.closest('.copy');
        if (!btn) return;
        navigator.clipboard.writeText(btn.dataset.sig).then(() => { btn.textContent = '‚úì'; setTimeout(() => btn.textContent = 'Copy', 1200); });
    });

    // Wallet connect/disconnect
    $('wbtn').onclick = async () => {
        if (connected) {
            wallet?.disconnect?.();
            $('wstat').textContent = 'Not Connected'; $('waddr').style.display = 'none';
            $('wbtn').textContent = 'Connect'; $('send').disabled = true;
            pubkey = null; connected = false; return;
        }
        wallet = window.solana;
        if (!wallet) return show($('stat'), 'err', 'Phantom not found');
        try {
            const { publicKey } = await wallet.connect();
            pubkey = publicKey;
            $('wstat').textContent = 'Connected';
            $('waddr').textContent = pubkey.toString(); $('waddr').style.display = 'block';
            $('wbtn').textContent = 'Disconnect';
            connected = true;
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:135',message:'Setting stat display to none after connect',data:{statElExists:!!$('stat')},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H1'})}).catch(()=>{});
            // #endregion
            $('stat').style.display = 'none';
            $('send').disabled = !$('msg').value.trim();
            wallet.on('disconnect', () => { $('wbtn').click(); });
        } catch (e) { show($('stat'), 'err', e.message); }
    };

    // Message input
    $('msg').oninput = () => {
        const t = $('msg').value, b = new TextEncoder().encode(t).length;
        $('chars').textContent = `${t.length}/500 (${b} bytes)`;
        $('chars').className = b > MAX ? 'chars err' : b > MAX * 0.9 ? 'chars warn' : 'chars';
        $('send').disabled = !connected || !t.trim() || b > MAX;
    };

    // Inscribe
    $('send').onclick = async () => {
        // #region agent log
        fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:142',message:'Inscribe button clicked',data:{hasMsg:!!$('msg')?.value?.trim(),hasPubkey:!!pubkey,statEl:!!$('stat'),statElId:$('stat')?.id||'null'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H2,H3'})}).catch(()=>{});
        // #endregion
        const msg = $('msg').value.trim(), bytes = new TextEncoder().encode(msg);
        if (!msg || !pubkey) return show($('stat'), 'err', 'Connect wallet & enter message');
        if (bytes.length > MAX) return show($('stat'), 'err', 'Message too long');

        $('send').disabled = true;
        // #region agent log
        fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:150',message:'About to call show() for fetching blockhash',data:{statElExists:!!$('stat')},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H3'})}).catch(()=>{});
        // #endregion
        show($('stat'), 'info', '‚ö° Fetching blockhash...');

        try {
            const bh = await rpc({ jsonrpc: '2.0', id: 1, method: 'getLatestBlockhash', params: [{ commitment: 'confirmed' }] });
            if (!bh?.data?.result?.value?.blockhash) throw new Error('No RPC available');
            const { blockhash } = bh.data.result.value;

            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:160',message:'Blockhash fetched, about to show approve message',data:{hasBlockhash:!!blockhash},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H3'})}).catch(()=>{});
            // #endregion
            show($('stat'), 'info', '‚úçÔ∏è Approve in wallet...');
            const tx = new solanaWeb3.Transaction({ recentBlockhash: blockhash, feePayer: pubkey });
            if ($('prio').checked) tx.add(solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ microLamports: 50000 }));
            tx.add(new solanaWeb3.TransactionInstruction({ keys: [{ pubkey, isSigner: true, isWritable: false }], programId: new solanaWeb3.PublicKey(MEMO), data: bytes }));

            const sig = await wallet.signAndSendTransaction(tx, { skipPreflight: false });
            const sigStr = typeof sig === 'string' ? sig : sig?.signature || sig;
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:168',message:'Transaction signed, got signature',data:{sigStr:sigStr?.substring(0,20)||'null'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H3'})}).catch(()=>{});
            // #endregion

            show($('stat'), 'info', '‚è≥ Confirming on-chain...');
            let status = 'pending';
            for (let i = 0; i < 12; i++) {
                await new Promise(r => setTimeout(r, 2500));
                const st = await rpc({ jsonrpc: '2.0', id: 1, method: 'getSignatureStatuses', params: [[sigStr], { searchTransactionHistory: true }] });
                const s = st?.data?.result?.value?.[0];
                if (s?.err) { status = 'failed'; break; }
                if (s?.confirmationStatus === 'confirmed' || s?.confirmationStatus === 'finalized') { status = 'confirmed'; break; }
            }
            
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:178',message:'Final status determined',data:{status,sigStr:sigStr?.substring(0,20)||'null'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H3'})}).catch(()=>{});
            // #endregion
            if (status === 'confirmed') {
                show($('stat'), 'ok', '‚úÖ SUCCESS! Your memo is permanently inscribed on Solana.');
                $('stat').innerHTML += `<br>üîó <a href="https://solscan.io/tx/${sigStr}" target="_blank">View on Solscan</a> <button class="copy" data-sig="${sigStr}">Copy TX</button>`;
            } else if (status === 'failed') {
                show($('stat'), 'err', '‚ùå Transaction failed on-chain. Try again.');
            } else {
                show($('stat'), 'info', '‚ö†Ô∏è Sent but not yet confirmed. It may still land.');
                $('stat').innerHTML += `<br>üîó <a href="https://solscan.io/tx/${sigStr}" target="_blank">Check Solscan</a> <button class="copy" data-sig="${sigStr}">Copy TX</button>`;
            }
            $('send').textContent = 'Inscribe Again';
        } catch (e) {
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:187',message:'Inscribe error caught',data:{error:e?.message||String(e),stack:e?.stack?.substring(0,100)||'none'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H3'})}).catch(()=>{});
            // #endregion
            show($('stat'), 'err', e.message); $('send').textContent = 'Retry';
        }
        $('send').disabled = false;
    };

    // Lookup
    $('lookup').onclick = async () => {
        const sig = $('txin').value.trim();
        if (!sig) return show($('lstat'), 'err', 'Paste a signature');
        $('lookup').disabled = true; $('lookup').textContent = '...';
        try {
            const r = await rpc({ jsonrpc: '2.0', id: 1, method: 'getTransaction', params: [sig, { encoding: 'jsonParsed', maxSupportedTransactionVersion: 0 }] });
            if (!r?.data?.result) throw new Error('TX not found');
            const ix = r.data.result.transaction.message.instructions.find(i => i.program === 'spl-memo' || i.programId === MEMO);
            if (!ix) throw new Error('No memo in TX');
            let memo = ix.parsed || ix.info?.memo;
            if (!memo && ix.data) { try { memo = new TextDecoder().decode(Uint8Array.from(atob(ix.data), c => c.charCodeAt(0))); } catch { memo = new TextDecoder().decode(b58(ix.data)); } }
            show($('lstat'), 'ok', `<b>Memo:</b> ${memo}`);
        } catch (e) { show($('lstat'), 'err', e.message); }
        $('lookup').disabled = false; $('lookup').textContent = 'Fetch Memo';
    };

    // Auto-connect
    // #region agent log
    fetch('http://127.0.0.1:7243/ingest/41c5f063-fb2c-493c-b473-49667be47a0f',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:215',message:'Page loaded, checking stat element',data:{statElExists:!!$('stat'),statElId:$('stat')?.id||'null',statElClassName:$('stat')?.className||'null',statElDisplay:$('stat')?.style?.display||'not-set',computedDisplay:$('stat')?window.getComputedStyle($('stat')).display:'el-not-found'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H2,H5'})}).catch(()=>{});
    // #endregion
    if (window.solana?.publicKey) { wallet = window.solana; pubkey = wallet.publicKey; $('wstat').textContent = 'Connected'; $('waddr').textContent = pubkey.toString(); $('waddr').style.display = 'block'; $('wbtn').textContent = 'Disconnect'; connected = true; }
    </script>
</body>
</html>
